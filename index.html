<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î™®Î∞îÏùº Ìö°Ïä§ÌÅ¨Î°§ RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Arial', sans-serif;
            user-select: none;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .controls {
            position: absolute;
            bottom: 60px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: auto;
        }
        .btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            active: scale(0.9);
        }
        .status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            border-radius: 8px;
            pointer-events: auto;
            min-width: 150px;
        }
        .dialog-box {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            background: white;
            border: 4px solid #444;
            padding: 15px;
            display: none;
            pointer-events: auto;
            z-index: 100;
        }
        .shop-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            display: none;
            pointer-events: auto;
            z-index: 101;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 300px;
            width: 90%;
        }
        #hidden-media {
            display: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hidden-media">
        <video id="jump-sound-vid" src="https://github.com/caxs23/runandjump/blob/main/jump.mp4?raw=true" preload="auto"></video>
        <audio id="bgm" src="https://orangefreesounds.com/wp-content/uploads/2021/05/Light-fantasy-background-music.mp3" loop></audio>
    </div>

    <div class="ui-overlay">
        <div class="status-bar">
            <div>Í≥®Îìú: <span id="gold">0</span>G</div>
            <div>Í≥µÍ≤©Î†•: <span id="power">10</span></div>
            <div>Ï†ÑÎ¶¨Ìíà: <span id="loot">0</span>Í∞ú</div>
            <div>ÏßÄÏó≠: <span id="location-name">ÎßàÏùÑ</span></div>
        </div>

        <div id="dialog" class="dialog-box">
            <p id="dialog-text">ÏÉÅÏù∏: Ï†ÑÎ¶¨ÌíàÏùÑ ÌåîÎü¨ ÏôîÎÇò?</p>
            <button onclick="sellLoot()" class="bg-blue-500 text-white px-4 py-1 mt-2 rounded">Ï†ÑÎ¶¨Ìíà ÌåêÎß§ (Í∞úÎãπ 10G)</button>
            <button onclick="toggleShop()" class="bg-green-500 text-white px-4 py-1 mt-2 rounded">Ïû•ÎπÑ ÏÉÅÏ†ê</button>
            <button onclick="closeDialog()" class="ml-2 text-gray-500 underline">Îã´Í∏∞</button>
        </div>

        <div id="shop" class="shop-menu">
            <h2 class="text-xl font-bold mb-4">Ïû•ÎπÑ ÏÉÅÏ†ê</h2>
            <div id="shop-items" class="space-y-3"></div>
            <button onclick="toggleShop()" class="mt-4 w-full bg-red-400 text-white py-2 rounded">ÎÇòÍ∞ÄÍ∏∞</button>
        </div>

        <div class="controls">
            <div class="flex gap-4">
                <div id="btn-left" class="btn">‚óÄ</div>
                <div id="btn-right" class="btn">‚ñ∂</div>
            </div>
            <div class="flex gap-4">
                <div id="btn-jump" class="btn">UP</div>
                <div id="btn-attack" class="btn bg-red-200">ATT</div>
                <div id="btn-action" class="btn bg-yellow-200">ACT</div>
            </div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const jumpVid = document.getElementById('jump-sound-vid');
const bgm = document.getElementById('bgm');

// Game State
const state = {
    gold: 0,
    loot: 0,
    attackPower: 10,
    weaponLevel: 1,
    location: 'town', // 'town', 'field1', 'field2', 'field3'
    dialogVisible: false,
    shopVisible: false,
    audioInitialized: false
};

const locations = {
    'town': { name: 'ÎßàÏùÑ', next: 'field1', prev: null },
    'field1': { name: 'Ï¥àÎ≥¥ ÏÇ¨ÎÉ•ÌÑ∞ (ÌÜ†ÎÅº)', next: 'field2', prev: 'town' },
    'field2': { name: 'Ï§ëÍ∏â ÏÇ¨ÎÉ•ÌÑ∞ (Ïó¨Ïö∞)', next: 'field3', prev: 'field1' },
    'field3': { name: 'ÏúÑÌóòÌïú ÏÇ¨ÎÉ•ÌÑ∞ (Î©ßÎèºÏßÄ)', next: null, prev: 'field2' }
};

const playerImg1 = new Image();
playerImg1.src = 'https://github.com/caxs23/plaffy-bird/blob/main/1-removebg-preview.png?raw=true';
const playerImg2 = new Image();
playerImg2.src = 'https://github.com/caxs23/plaffy-bird/blob/main/2-removebg-preview.png?raw=true';

const GRAVITY = 0.6;
const GROUND_Y = 0.8;

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const keys = { left: false, right: false, jump: false, attack: false };

function initAudio() {
    if (!state.audioInitialized) {
        bgm.play().catch(() => {});
        state.audioInitialized = true;
    }
}

function playJumpEffect() {
    jumpVid.currentTime = 0;
    jumpVid.play().catch(() => {});
}

function setupControls() {
    const bind = (id, key) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); initAudio(); keys[key] = true; 
        });
        el.addEventListener('touchend', (e) => { 
            e.preventDefault(); keys[key] = false; 
        });
        el.addEventListener('mousedown', () => { initAudio(); keys[key] = true; });
        el.addEventListener('mouseup', () => keys[key] = false);
    };
    bind('btn-left', 'left');
    bind('btn-right', 'right');
    bind('btn-jump', 'jump');
    
    document.getElementById('btn-attack').addEventListener('click', () => { initAudio(); player.attack(); });
    document.getElementById('btn-action').addEventListener('click', () => { initAudio(); player.interact(); });
}

// Entity Class for AI (NPCs and Monsters)
class Entity {
    constructor(x, y, size, emoji, hp = 0) {
        this.x = x;
        this.y = y;
        this.size = size;
        this.emoji = emoji;
        this.hp = hp;
        this.initialHp = hp;
        this.dead = false;
        this.vx = 0;
        this.moveTimer = 0;
        this.direction = Math.random() > 0.5 ? 1 : -1;
    }

    update() {
        if (this.dead) return;
        
        // Simple AI: Move randomly
        this.moveTimer--;
        if (this.moveTimer <= 0) {
            this.moveTimer = 60 + Math.random() * 120;
            const rand = Math.random();
            if (rand < 0.3) this.vx = 0; // Stop
            else if (rand < 0.65) this.vx = 1; // Right
            else this.vx = -1; // Left
        }

        this.x += this.vx * 0.5;

        // Boundary
        if (this.x < 50) this.vx = 1;
        if (this.x > canvas.width - 50) this.vx = -1;
    }

    draw() {
        if (this.dead) return;
        ctx.save();
        ctx.font = `${this.size}px serif`;
        ctx.textAlign = 'center';
        ctx.fillText(this.emoji, this.x, this.y + this.size);
        
        if (this.hp > 0) {
            // HP Bar
            const barW = this.size;
            ctx.fillStyle = 'red';
            ctx.fillRect(this.x - barW/2, this.y - 10, barW, 5);
            ctx.fillStyle = 'green';
            ctx.fillRect(this.x - barW/2, this.y - 10, barW * (this.hp / this.initialHp), 5);
        }
        ctx.restore();
    }
}

const player = {
    x: 100,
    y: 0,
    width: 90,
    height: 80,
    vx: 0,
    vy: 0,
    speed: 5,
    jumpPower: -12,
    isGrounded: false,
    direction: 1,
    frame: 0,
    walkCounter: 0,
    isAttacking: false,
    attackCooldown: 0,

    update() {
        if (keys.left) { this.vx = -this.speed; this.direction = -1; this.walkCounter++; }
        else if (keys.right) { this.vx = this.speed; this.direction = 1; this.walkCounter++; }
        else { this.vx *= 0.8; this.walkCounter = 0; }

        if (keys.jump && this.isGrounded) {
            this.vy = this.jumpPower;
            this.isGrounded = false;
            playJumpEffect();
        }

        this.vy += GRAVITY;
        this.x += this.vx;
        this.y += this.vy;

        const groundLevel = canvas.height * GROUND_Y - this.height;
        if (this.y > groundLevel) { this.y = groundLevel; this.vy = 0; this.isGrounded = true; }

        // Location Transitions
        const loc = locations[state.location];
        if (this.x < -20) {
            if (loc.prev) {
                state.location = loc.prev;
                this.x = canvas.width - this.width;
                changeLocation();
            } else { this.x = -20; }
        }
        if (this.x > canvas.width - (this.width / 2)) {
            if (loc.next) {
                state.location = loc.next;
                this.x = 20;
                changeLocation();
            } else { this.x = canvas.width - (this.width / 2); }
        }

        if (this.attackCooldown > 0) this.attackCooldown--;
        if (this.attackCooldown < 10) this.isAttacking = false;
        this.frame = (Math.floor(this.walkCounter / 10) % 2);
    },

    draw() {
        ctx.save();
        if (this.direction === -1) {
            ctx.scale(-1, 1);
            ctx.translate(-this.x - this.width, this.y);
        } else { ctx.translate(this.x, this.y); }
        const img = (this.walkCounter > 0 || !this.isGrounded) ? (this.frame === 0 ? playerImg1 : playerImg2) : playerImg1;
        ctx.drawImage(img, 0, 0, this.width, this.height);
        if (this.isAttacking) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.beginPath();
            ctx.arc(this.width + 10, this.height / 2, 20, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.restore();
    },

    attack() {
        if (this.attackCooldown > 0) return;
        this.isAttacking = true;
        this.attackCooldown = 20;
        playJumpEffect();
        if (state.location.startsWith('field')) {
            monsters.forEach(m => {
                if (!m.dead) {
                    const dist = Math.abs(this.x - m.x);
                    if (dist < 100) {
                        m.hp -= state.attackPower;
                        if (m.hp <= 0) { m.dead = true; state.loot++; updateUI(); }
                    }
                }
            });
        }
    },

    interact() {
        if (state.location === 'town' && Math.abs(this.x - canvas.width/2) < 100) {
            state.dialogVisible = true;
            document.getElementById('dialog').style.display = 'block';
        }
    }
};

const monsters = [];
const villagers = [];

function changeLocation() {
    monsters.length = 0;
    villagers.length = 0;
    
    if (state.location === 'town') {
        // Spawn wandering villagers
        for (let i = 0; i < 3; i++) {
            villagers.push(new Entity(
                100 + Math.random() * (canvas.width - 200),
                canvas.height * GROUND_Y - 50,
                50,
                ['üë¶', 'üë©', 'üë¥'][i % 3]
            ));
        }
    } else {
        // Spawn wandering monsters based on field level
        let type;
        if (state.location === 'field1') type = { emoji: 'üê∞', hp: 20, size: 40 };
        else if (state.location === 'field2') type = { emoji: 'ü¶ä', hp: 60, size: 50 };
        else if (state.location === 'field3') type = { emoji: 'üêó', hp: 150, size: 65 };
        
        for (let i = 0; i < 4; i++) {
            monsters.push(new Entity(
                300 + Math.random() * (canvas.width - 400),
                canvas.height * GROUND_Y - type.size,
                type.size,
                type.emoji,
                type.hp
            ));
        }
    }
    updateUI();
}

function drawBackground() {
    const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
    grad.addColorStop(0, '#87CEEB');
    grad.addColorStop(1, '#E0F6FF');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(100, 100, 30, 0, Math.PI*2); ctx.arc(130, 100, 40, 0, Math.PI*2); ctx.arc(170, 100, 30, 0, Math.PI*2);
    ctx.fill();

    // Thematic mountains
    ctx.fillStyle = state.location === 'field3' ? '#4a3c3c' : '#4A7c59';
    ctx.beginPath();
    ctx.moveTo(-100, canvas.height * GROUND_Y); ctx.lineTo(200, canvas.height * 0.4); ctx.lineTo(500, canvas.height * GROUND_Y);
    ctx.fill();

    ctx.fillStyle = state.location === 'town' ? '#999' : (state.location === 'field3' ? '#5c4b3a' : '#7cfc00');
    ctx.fillRect(0, canvas.height * GROUND_Y, canvas.width, canvas.height * (1 - GROUND_Y));
    
    if (state.location === 'town') {
        ctx.font = '60px serif';
        ctx.fillText('üë®‚Äçüåæ', canvas.width/2, canvas.height * GROUND_Y - 10);
        ctx.font = '16px Arial'; ctx.fillStyle = 'black'; ctx.textAlign = 'center';
        ctx.fillText('ÏÉÅÏù∏ (ACT ÌÅ¥Î¶≠)', canvas.width/2, canvas.height * GROUND_Y - 80);
    }
}

function updateUI() {
    document.getElementById('gold').innerText = state.gold;
    document.getElementById('power').innerText = state.attackPower;
    document.getElementById('loot').innerText = state.loot;
    document.getElementById('location-name').innerText = locations[state.location].name;
}

function sellLoot() {
    if (state.loot > 0) {
        state.gold += state.loot * 15; // Increased price
        state.loot = 0; updateUI();
        document.getElementById('dialog-text').innerText = "ÏÉÅÏù∏: ÌõåÎ•≠ÌïòÍµ∞! Îçî ÎßéÏù¥ Í∞ÄÏ†∏Ïò§Í≤åÎÇò.";
    } else { document.getElementById('dialog-text').innerText = "ÏÉÅÏù∏: ÎπàÏÜêÏù¥Íµ¨Îßå?"; }
}

function closeDialog() {
    state.dialogVisible = false;
    document.getElementById('dialog').style.display = 'none';
    document.getElementById('shop').style.display = 'none';
}

const shopItems = [
    { name: "ÎÇ°ÏùÄ Î™©Í≤Ä", power: 25, price: 100, level: 2 },
    { name: "Í∞ïÏ≤† Í≤Ä", power: 55, price: 400, level: 3 },
    { name: "ÎßàÎ≤ï ÎåÄÍ≤Ä", power: 120, price: 1200, level: 4 },
    { name: "Ïã†ÌôîÏùò Í≤Ä", power: 300, price: 5000, level: 5 }
];

function toggleShop() {
    state.shopVisible = !state.shopVisible;
    const shopEl = document.getElementById('shop');
    shopEl.style.display = state.shopVisible ? 'block' : 'none';
    if (state.shopVisible) {
        const itemsContainer = document.getElementById('shop-items');
        itemsContainer.innerHTML = '';
        shopItems.forEach(item => {
            const isOwned = state.weaponLevel >= item.level;
            const btn = document.createElement('div');
            btn.className = "flex justify-between items-center border-b pb-2";
            btn.innerHTML = `<div><div class="font-bold">${item.name}</div><div class="text-xs text-gray-500">Í≥µÎ†•: ${item.power}</div></div>
                <button onclick="buyItem(${item.level}, ${item.price}, ${item.power})" class="px-3 py-1 rounded ${isOwned ? 'bg-gray-300' : 'bg-yellow-400'}" ${isOwned ? 'disabled' : ''}>${isOwned ? 'Î≥¥Ïú†Ï§ë' : item.price + 'G'}</button>`;
            itemsContainer.appendChild(btn);
        });
    }
}

window.buyItem = function(level, price, power) {
    if (state.gold >= price) {
        state.gold -= price; state.weaponLevel = level; state.attackPower = power;
        updateUI(); toggleShop(); toggleShop();
        document.getElementById('dialog-text').innerText = "ÏÉÅÏù∏: Î¨¥Í∏∞Í∞Ä ÏïÑÏ£º ÎÇ†Ïπ¥Î°úÏõåÏ°åÍµ∞!";
    } else { alert("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!"); }
};

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    player.update();
    player.draw();

    if (state.location === 'town') {
        villagers.forEach(v => { v.update(); v.draw(); });
    } else {
        monsters.forEach(m => { m.update(); m.draw(); });
    }
    requestAnimationFrame(loop);
}

setupControls();
changeLocation(); // Initial spawn
requestAnimationFrame(loop);
</script>
</body>
</html>
