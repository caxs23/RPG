<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ë°”ì¼ íš¡ìŠ¤í¬ë¡¤ RPG: ì—í”½ ì›”ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
            user-select: none;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        canvas {
            display: block;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        /* ìƒë‹¨ UI ë ˆì´ì•„ì›ƒ ìµœì í™” */
        .top-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            pointer-events: auto;
        }
        .status-card {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        /* ê²½í—˜ì¹˜ ë°” ì¶”ê°€ */
        .xp-container {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
            position: relative;
        }
        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #6b46c1, #b794f4);
            width: 0%;
            transition: width 0.3s;
        }
        .hp-text { color: #f56565; font-weight: bold; }
        
        .quest-card {
            background: rgba(251, 191, 36, 0.95);
            color: #000;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: bold;
            align-self: flex-end;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid #fff;
        }
        
        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬ ìœ„ì¹˜ ì¡°ì • */
        .controls {
            position: absolute;
            bottom: 80px; 
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            pointer-events: auto;
        }
        .control-group {
            display: flex;
            gap: 12px;
        }
        .btn {
            width: 58px;
            height: 58px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .btn:active { transform: scale(0.9); background: rgba(255,255,255,0.5); }
        .btn-action { background: rgba(237, 137, 54, 0.6); border-color: #ed8936; }
        .btn-attack { background: rgba(245, 101, 101, 0.6); border-color: #f56565; }

        .dialog-box {
            position: absolute;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            background: rgba(26, 32, 44, 0.98);
            border: 2px solid #a0aec0;
            padding: 15px;
            border-radius: 12px;
            display: none;
            pointer-events: auto;
            z-index: 100;
            color: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        .shop-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a202c;
            padding: 20px;
            border-radius: 16px;
            display: none;
            pointer-events: auto;
            z-index: 101;
            width: 88%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #ed8936;
        }
        #hidden-media { display: none; }
        
        /* ë ˆë²¨ì—… íš¨ê³¼ */
        @keyframes levelUpAnim {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .level-up-overlay {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 0 0 10px #b794f4;
            pointer-events: none;
            display: none;
        }
        .level-up-active {
            display: block;
            animation: levelUpAnim 2s forwards;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hidden-media">
        <video id="jump-sound-vid" src="https://github.com/caxs23/runandjump/blob/main/jump.mp4?raw=true" preload="auto"></video>
        <audio id="bgm" src="https://orangefreesounds.com/wp-content/uploads/2021/05/Light-fantasy-background-music.mp3" loop></audio>
    </div>

    <div class="level-up-overlay" id="lvl-up-msg">LEVEL UP!</div>

    <div class="ui-overlay">
        <div class="top-ui">
            <div class="status-card">
                <div class="flex flex-col w-full">
                    <div class="flex justify-between items-center w-full mb-1">
                        <div class="flex gap-2 text-sm">
                            <span class="text-yellow-400 font-bold">LV.<span id="level">1</span></span>
                            <span class="hp-text">HP <span id="hp">100</span>/<span id="max-hp">100</span></span>
                        </div>
                        <div class="font-bold text-gray-300 text-xs">ğŸ“ <span id="location-name">ë§ˆì„</span></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>ğŸ’° <span id="gold">0</span></span>
                        <span>âš”ï¸ <span id="power">10</span></span>
                        <span>ğŸ“¦ <span id="loot">0</span></span>
                    </div>
                    <div class="xp-container">
                        <div id="xp-bar" class="xp-bar"></div>
                    </div>
                </div>
            </div>
            <div id="quest-ui" class="quest-card">
                ğŸ“œ <span id="quest-desc">ìƒì¸ê³¼ ëŒ€í™”í•˜ê¸°</span>
            </div>
        </div>

        <div id="dialog" class="dialog-box">
            <div id="speaker-name" class="font-bold text-blue-300 mb-1">ìƒì¸</div>
            <p id="dialog-text" class="text-sm">ì „ë¦¬í’ˆì„ íŒ”ëŸ¬ ì™”ë‚˜?</p>
            <div id="dialog-buttons" class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <div id="shop" class="shop-menu text-white">
            <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                <h2 class="text-xl font-bold text-orange-400">ì „ì„¤ì˜ ëŒ€ì¥ê°„</h2>
                <div class="text-sm">ğŸ’° <span id="shop-gold">0</span></div>
            </div>
            <div id="shop-items" class="space-y-2"></div>
            <button onclick="toggleShop()" class="mt-4 w-full bg-gray-600 py-3 rounded-xl font-bold">ìƒì  ë‹«ê¸°</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <div id="btn-left" class="btn">â—€</div>
                <div id="btn-right" class="btn">â–¶</div>
            </div>
            <div class="control-group">
                <div id="btn-jump" class="btn">UP</div>
                <div id="btn-attack" class="btn btn-attack">ATK</div>
                <div id="btn-action" class="btn btn-action">ACT</div>
            </div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const jumpVid = document.getElementById('jump-sound-vid');
const bgm = document.getElementById('bgm');

// --- GAME STATE ENHANCED ---
const state = {
    gold: 0,
    loot: 0,
    attackPower: 10,
    weaponLevel: 1,
    location: 'town_start',
    dialogVisible: false,
    shopVisible: false,
    audioInitialized: false,
    questStep: 0,
    kills: 0,
    chestsFound: [],
    // New Stats
    level: 1,
    xp: 0,
    maxXp: 100,
    hp: 100,
    maxHp: 100,
    screenShake: 0,
    time: 0 // For day/night cycle
};

// --- EXPANDED LOCATIONS (15 Maps + Dungeons) ---
const locations = {
    'town_start': { name: 'ì‹œì‘ì˜ ë§ˆì„', next: 'field_slime', prev: null, bg: '#87CEEB', type: 'town' },
    'field_slime': { name: 'ìŠ¬ë¼ì„ í‰ì›', next: 'field_forest_1', prev: 'town_start', bg: '#7cfc00', type: 'field', enemy: 'ğŸ’§', weather: 'none' },
    'field_forest_1': { name: 'ê³ ìš”í•œ ìˆ²', next: 'field_forest_2', prev: 'field_slime', bg: '#2d5a27', type: 'field', enemy: 'ğŸ°', weather: 'none' },
    'field_forest_2': { name: 'ê¹Šì€ ìˆ²', next: 'field_bridge', prev: 'field_forest_1', bg: '#1a3c18', type: 'field', enemy: 'ğŸ¦Š', weather: 'rain' },
    'field_bridge': { name: 'ì˜¤ë˜ëœ ë‹¤ë¦¬', next: 'town_second', prev: 'field_forest_2', bg: '#4a7c59', type: 'field', enemy: 'ğŸ—', weather: 'rain' },
    
    'town_second': { name: 'ë¬´ì—­ ë„ì‹œ', next: 'field_desert_1', prev: 'field_bridge', bg: '#fbd38d', type: 'town' },
    'field_desert_1': { name: 'ë©”ë§ˆë¥¸ ì‚¬ë§‰', next: 'field_desert_2', prev: 'town_second', bg: '#ecc94b', type: 'field', enemy: 'ğŸ¦‚', weather: 'none' },
    'field_desert_2': { name: 'ëª¨ë˜ í­í’', next: 'field_oasis', prev: 'field_desert_1', bg: '#d69e2e', type: 'field', enemy: 'ğŸŒµ', weather: 'sand' },
    'field_oasis': { name: 'ì˜¤ì•„ì‹œìŠ¤', next: 'field_cave_1', prev: 'field_desert_2', bg: '#4fd1c5', type: 'field', enemy: 'ğŸ', weather: 'none' },
    
    'field_cave_1': { name: 'ë™êµ´ ì…êµ¬', next: 'field_cave_2', prev: 'field_oasis', bg: '#4a5568', type: 'field', enemy: 'ğŸ¦‡', weather: 'dark' },
    'field_cave_2': { name: 'ì‹¬ì—°ì˜ ë™êµ´', next: 'field_volcano', prev: 'field_cave_1', bg: '#2d3748', type: 'field', enemy: 'ğŸ•·ï¸', weather: 'dark' },
    
    'field_volcano': { name: 'ìš©ì•” ì§€ëŒ€', next: 'town_castle', prev: 'field_cave_2', bg: '#c53030', type: 'field', enemy: 'ğŸ”¥', weather: 'ash' },
    'town_castle': { name: 'ìµœí›„ì˜ ìš”ìƒˆ', next: 'field_snow', prev: 'field_volcano', bg: '#718096', type: 'town' },
    
    'field_snow': { name: 'ì„¤ì›', next: 'field_sky', prev: 'town_castle', bg: '#e2e8f0', type: 'field', enemy: 'ğŸº', weather: 'snow' },
    'field_sky': { name: 'í•˜ëŠ˜ ì„¬', next: 'boss_lair', prev: 'field_snow', bg: '#ebf8ff', type: 'field', enemy: 'ğŸ¦…', weather: 'none' },
    'boss_lair': { name: 'ë§ˆì™•ì˜ ì„±', next: null, prev: 'field_sky', bg: '#1a202c', type: 'field', enemy: 'ğŸ‘¿', weather: 'thunder' }
};

const playerImg1 = new Image(); playerImg1.src = 'https://github.com/caxs23/plaffy-bird/blob/main/1-removebg-preview.png?raw=true';
const playerImg2 = new Image(); playerImg2.src = 'https://github.com/caxs23/plaffy-bird/blob/main/2-removebg-preview.png?raw=true';

const GRAVITY = 0.6;
const GROUND_Y = 0.75;

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

const keys = { left: false, right: false, jump: false };

// Visual Effect Arrays
const particles = [];
const damageTexts = [];
const droppedItems = [];

function initAudio() {
    if (!state.audioInitialized) { bgm.play().catch(() => {}); state.audioInitialized = true; }
}

function playJumpEffect() { jumpVid.currentTime = 0; jumpVid.play().catch(() => {}); }

// --- ENHANCED CLASSES ---

class Particle {
    constructor(x, y, color, type = 'normal') {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 8;
        this.vy = (Math.random() - 0.5) * 8;
        this.life = 1.0;
        this.color = color;
        this.type = type; // normal, rain, snow
        if (type === 'rain') { this.vx = -2; this.vy = 10; this.life = 0.6; }
        if (type === 'snow') { this.vx = Math.random() - 0.5; this.vy = 2; this.life = 1.5; }
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if (this.type === 'normal') this.life -= 0.03;
        else if (this.y > canvas.height) this.life = 0;
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.type==='normal'?4:2, this.type==='normal'?4:8);
    }
}

class DamageText {
    constructor(x, y, damage, isCrit) {
        this.x = x; this.y = y;
        this.text = damage;
        this.isCrit = isCrit;
        this.life = 1.0;
        this.vy = -2;
    }
    update() {
        this.y += this.vy;
        this.life -= 0.02;
    }
    draw() {
        ctx.save();
        ctx.font = this.isCrit ? 'bold 24px Arial' : 'bold 18px Arial';
        ctx.fillStyle = this.isCrit ? '#ffff00' : '#ffffff';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 3;
        ctx.strokeText(this.text, this.x, this.y);
        ctx.fillText(this.text, this.x, this.y);
        if (this.isCrit) ctx.fillText("CRIT!", this.x, this.y - 20);
        ctx.restore();
    }
}

class DroppedItem {
    constructor(x, y, type) {
        this.x = x; this.y = y;
        this.type = type; // 'gold', 'heart'
        this.vy = -5; // Pop up effect
        this.groundY = y;
        this.bounced = false;
        this.life = 1000;
    }
    update() {
        this.vy += GRAVITY;
        this.y += this.vy;
        if (this.y > this.groundY) {
            this.y = this.groundY;
            if (!this.bounced) { this.vy = -3; this.bounced = true; }
            else { this.vy = 0; }
        }
        this.life--;
    }
    draw() {
        ctx.font = '24px serif';
        ctx.fillText(this.type === 'gold' ? 'ğŸ’°' : 'â¤ï¸', this.x, this.y);
    }
}

class Entity {
    constructor(x, y, size, emoji, hp = 0, isNpc = false, isElite = false) {
        this.x = x; this.y = y; this.size = size; this.emoji = emoji;
        this.isNpc = isNpc;
        this.isElite = isElite;
        this.maxHp = hp * (isElite ? 3 : 1);
        this.hp = this.maxHp;
        this.dead = false; this.vx = 0; this.moveTimer = 0;
        this.hitTimer = 0;
        if (isElite) this.size *= 1.5;
    }

    update() {
        if (this.dead) return;
        this.moveTimer--;
        if (this.moveTimer <= 0) {
            this.moveTimer = 60 + Math.random() * 120;
            const r = Math.random();
            this.vx = r < 0.3 ? 0 : (r < 0.65 ? 1 : -1);
        }
        this.x += this.vx * (this.isNpc ? 0.3 : 0.8);
        if (this.x < 50) this.vx = 1;
        if (this.x > canvas.width - 50) this.vx = -1;
        if (this.hitTimer > 0) this.hitTimer--;
    }

    draw() {
        if (this.dead) return;
        ctx.save();
        if (this.hitTimer > 0) ctx.filter = 'brightness(2) sepia(1) hue-rotate(-50deg)';
        ctx.font = `${this.size}px serif`;
        ctx.textAlign = 'center';
        
        // Elite Glow
        if (this.isElite) {
            ctx.shadowColor = "yellow";
            ctx.shadowBlur = 15;
        }

        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(this.emoji, this.x, this.y + this.size);
        ctx.shadowBlur = 0;

        if (this.hp > 0 && !this.isNpc) {
            const barW = this.size;
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(this.x - barW/2, this.y - 15, barW, 4);
            ctx.fillStyle = this.isElite ? '#FFD700' : '#00FF00';
            ctx.fillRect(this.x - barW/2, this.y - 15, barW * (this.hp / this.maxHp), 4);
        }
        ctx.restore();
    }
}

class Chest {
    constructor(x, y) {
        this.x = x; this.y = y; this.id = `${state.location}_${Math.floor(x)}`;
        this.opened = state.chestsFound.includes(this.id);
    }
    draw() {
        ctx.save();
        ctx.font = '40px serif';
        ctx.textAlign = 'center';
        ctx.fillText(this.opened ? 'ğŸ”“' : 'ğŸ', this.x, this.y);
        if (!this.opened) {
            ctx.fillStyle = 'yellow';
            ctx.globalAlpha = 0.6 + Math.sin(Date.now()/200)*0.4;
            ctx.beginPath();
            ctx.arc(this.x, this.y - 20, 30, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }
}

const player = {
    x: 100, y: 0, width: 70, height: 65, vx: 0, vy: 0,
    speed: 5.5, jumpPower: -12, isGrounded: false, direction: 1,
    frame: 0, walkCounter: 0, isAttacking: false, attackCooldown: 0,

    update() {
        if (keys.left) { this.vx = -this.speed; this.direction = -1; this.walkCounter++; }
        else if (keys.right) { this.vx = this.speed; this.direction = 1; this.walkCounter++; }
        else { this.vx *= 0.8; this.walkCounter = 0; }

        if (keys.jump && this.isGrounded) { this.vy = this.jumpPower; this.isGrounded = false; playJumpEffect(); }
        this.vy += GRAVITY; this.x += this.vx; this.y += this.vy;

        const g = canvas.height * GROUND_Y - this.height;
        if (this.y > g) { this.y = g; this.vy = 0; this.isGrounded = true; }

        const loc = locations[state.location];
        if (this.x < -20 && loc.prev) { state.location = loc.prev; this.x = canvas.width - 100; changeLocation(); }
        if (this.x > canvas.width - 40 && loc.next) { state.location = loc.next; this.x = 20; changeLocation(); }

        if (this.attackCooldown > 0) this.attackCooldown--;
        if (this.attackCooldown < 12) this.isAttacking = false;
        this.frame = (Math.floor(this.walkCounter / 8) % 2);

        // Pick up items
        for (let i = droppedItems.length - 1; i >= 0; i--) {
            const item = droppedItems[i];
            const dist = Math.abs((this.x + this.width/2) - item.x);
            if (dist < 50) {
                if (item.type === 'gold') {
                    state.gold += 10 + Math.floor(Math.random() * 20); // Random Gold
                    spawnParticle(item.x, item.y, '#ffd700', 5);
                } else if (item.type === 'heart') {
                    state.hp = Math.min(state.hp + 20, state.maxHp);
                    spawnParticle(item.x, item.y, '#ff0000', 5);
                }
                droppedItems.splice(i, 1);
                updateUI();
            }
        }
    },

    draw() {
        ctx.save();
        if (this.direction === -1) { ctx.scale(-1, 1); ctx.translate(-this.x - this.width, this.y); }
        else { ctx.translate(this.x, this.y); }
        const img = (this.walkCounter > 0 || !this.isGrounded) ? (this.frame === 0 ? playerImg1 : playerImg2) : playerImg1;
        
        if (this.isAttacking) {
            ctx.strokeStyle = 'rgba(255,255,255,0.8)';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(this.width, this.height/2, 40, -Math.PI/2, Math.PI/2);
            ctx.stroke();
        }
        ctx.drawImage(img, 0, 0, this.width, this.height);
        ctx.restore();
    },

    attack() {
        if (this.attackCooldown > 0) return;
        this.isAttacking = true; this.attackCooldown = 25;
        spawnParticle(this.x + this.width/2, this.y + this.height/2, '#fff', 5);
        
        const targets = [...monsters, ...villagers];
        targets.forEach(m => {
            if (!m.dead) {
                const dist = Math.abs((this.x + this.width/2) - m.x);
                if (dist < 110) {
                    // Critical Hit Logic
                    const isCrit = Math.random() < 0.2; // 20% Crit Chance
                    const dmg = Math.floor(state.attackPower * (isCrit ? 2 : 1) * (0.9 + Math.random() * 0.2));
                    
                    m.hp -= dmg;
                    m.hitTimer = 10;
                    state.screenShake = 5; // Add shake
                    
                    // Spawn Damage Text
                    damageTexts.push(new DamageText(m.x, m.y, dmg, isCrit));
                    spawnParticle(m.x, m.y + m.size/2, '#ff0000', 8);

                    if (m.isNpc) { 
                        showDialog("ì£¼ë¯¼", "ìœ¼ì•…! ê²½ë¹„ë³‘!!!"); 
                        m.vx = this.direction * 4; 
                    }
                    if (m.hp <= 0) {
                        m.dead = true;
                        if (!m.isNpc) {
                            // Rewards
                            state.kills++;
                            const xpGain = m.isElite ? 50 : 15;
                            gainXp(xpGain);
                            
                            // Drop Items
                            droppedItems.push(new DroppedItem(m.x, m.y, 'gold'));
                            if (Math.random() < 0.3) droppedItems.push(new DroppedItem(m.x + 10, m.y, 'gold')); // Bonus gold
                            if (Math.random() < 0.2) droppedItems.push(new DroppedItem(m.x - 10, m.y, 'heart')); // Heal
                            
                            if (m.isElite) {
                                state.loot += 3; // Elites drop more loot
                                for(let k=0; k<5; k++) droppedItems.push(new DroppedItem(m.x + (k*5), m.y, 'gold'));
                            } else {
                                state.loot++;
                            }
                            checkQuest();
                        } else {
                            state.gold = Math.max(0, state.gold - 100); // NPC penalty
                        }
                        updateUI();
                    }
                }
            }
        });
    }
};

const monsters = [];
const villagers = [];
const chests = [];

function spawnParticle(x, y, color, count) {
    for (let i = 0; i < count; i++) {
        particles.push(new Particle(x, y, color));
    }
}

function gainXp(amount) {
    state.xp += amount;
    if (state.xp >= state.maxXp) {
        state.xp -= state.maxXp;
        state.level++;
        state.maxXp = Math.floor(state.maxXp * 1.5);
        state.maxHp += 20;
        state.hp = state.maxHp; // Full heal
        state.attackPower += 5;
        
        // Level Up Effect
        const msg = document.getElementById('lvl-up-msg');
        msg.classList.remove('level-up-active');
        void msg.offsetWidth; // Trigger reflow
        msg.classList.add('level-up-active');
        spawnParticle(player.x, player.y, '#ffd700', 30);
    }
    updateUI();
}

function changeLocation() {
    monsters.length = 0; villagers.length = 0; chests.length = 0; droppedItems.length = 0; particles.length = 0;
    const loc = locations[state.location];
    
    if (loc.type === 'town') {
        for (let i = 0; i < 3; i++) {
            villagers.push(new Entity(100 + Math.random() * (canvas.width - 200), canvas.height * GROUND_Y - 45, 50, ['ğŸ‘¦', 'ğŸ‘©', 'ğŸ‘´', 'ğŸ‘®', 'ğŸ¤´'][Math.floor(Math.random()*5)], 100, true));
        }
    } else {
        const count = state.location === 'boss_lair' ? 1 : 4;
        const hpBase = state.location === 'boss_lair' ? 5000 : 50 + (state.level * 20); // Scaling HP
        for (let i = 0; i < count; i++) {
            const isElite = Math.random() < 0.15 && state.location !== 'boss_lair'; // 15% Elite chance
            monsters.push(new Entity(
                300 + Math.random() * (canvas.width - 400), 
                canvas.height * GROUND_Y - (isElite ? 70 : 55), 
                isElite ? 70 : 55, 
                loc.enemy, 
                hpBase,
                false,
                isElite
            ));
        }
    }
    if (Math.random() > 0.4) {
        chests.push(new Chest(Math.random() * (canvas.width - 100) + 50, canvas.height * GROUND_Y - 10));
    }
    updateUI();
}

// ... Interaction and Dialog functions remain similar but enhanced ...

function interactLogic() {
    let foundNpc = false;
    villagers.forEach(v => {
        if (!v.dead && Math.abs(player.x - v.x) < 80) { foundNpc = true; handleNpcDialog(v.emoji); }
    });
    if (!foundNpc && locations[state.location].type === 'town' && Math.abs(player.x - canvas.width/2) < 80) {
        handleNpcDialog('ğŸ‘¨â€ğŸŒ¾');
    }
    chests.forEach(c => {
        if (!c.opened && Math.abs(player.x - c.x) < 60) {
            c.opened = true;
            state.chestsFound.push(c.id);
            const reward = 200 + Math.floor(Math.random() * 500);
            state.gold += reward;
            
            // Random Potion in chest
            if (Math.random() > 0.5) {
                droppedItems.push(new DroppedItem(c.x, c.y - 20, 'heart'));
                showDialog("ì‹œìŠ¤í…œ", `ìƒìì—ì„œ ${reward}Gì™€ ë¬¼ì•½ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!`);
            } else {
                showDialog("ì‹œìŠ¤í…œ", `ìˆ¨ê²¨ì§„ ë³´ë¬¼ ${reward}Gë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!`);
            }
            
            spawnParticle(c.x, c.y, '#ffd700', 20);
            updateUI();
        }
    });
}

function handleNpcDialog(emoji) {
    let name = "ì£¼ë¯¼", text = "ì•ˆë…•í•˜ì„¸ìš”, ëª¨í—˜ê°€ë‹˜!", btns = [{t: "ë‹«ê¸°", f: closeDialog}];
    if (emoji === 'ğŸ‘¨â€ğŸŒ¾') {
        name = "ëŒ€ì¥ì¥ì´";
        text = "ì–´ì„œì˜¤ê²Œ! ë¬´ì—‡ì„ ë„ì™€ì¤„ê¹Œ?";
        btns = [
            {t: "ì „ë¦¬í’ˆ íŒë§¤ (ê°œë‹¹ 30G)", f: sellLoot},
            {t: "ìƒì  ì—´ê¸°", f: toggleShop},
            {t: "ì²´ë ¥ íšŒë³µ (100G)", f: healPlayer},
            {t: "ë‹«ê¸°", f: closeDialog}
        ];
        if (state.questStep === 0) {
            state.questStep = 1;
            text = "ìš”ì¦˜ ëª¬ìŠ¤í„°ë“¤ì´ í‰í¬í•´ì¡Œì–´. 5ë§ˆë¦¬ë§Œ ì²˜ë¦¬í•´ì£¼ë©´ ì‚¬ë¡€í•˜ê² ë„¤.";
            checkQuest();
        } else if (state.questStep === 2) {
            state.questStep = 3; state.gold += 1000; gainXp(100);
            text = "ì˜¤! ì •ë§ í›Œë¥­í•œ ì‹¤ë ¥ì´êµ°! ì—¬ê¸° ë³´ìƒì¼ì„¸. (+1000G, +100XP)";
            checkQuest();
        }
    } else if (emoji === 'ğŸ‘´') { name = "ì´Œì¥"; text = "ë™ìª½ ë ë§ˆì™•ì˜ ì„±ì— ì „ì„¤ì˜ ë³´ë¬¼ì´ ìˆë‹¤ëŠ” ì†Œë¬¸ì´..."; }
    else if (emoji === 'ğŸ‘®') { name = "ê²½ë¹„ë³‘"; text = "ë°¤ì´ ë˜ë©´ ëª¬ìŠ¤í„°ë“¤ì´ ë” ê°•í•´ì§€ë‹ˆ ì¡°ì‹¬í•˜ì‹œì˜¤."; }
    showDialog(name, text, btns);
}

function healPlayer() {
    if (state.gold >= 100) {
        state.gold -= 100;
        state.hp = state.maxHp;
        updateUI();
        spawnParticle(player.x, player.y, '#00ff00', 15);
        showDialog("ëŒ€ì¥ì¥ì´", "ì²´ë ¥ì´ ëª¨ë‘ íšŒë³µë˜ì—ˆë„¤!");
    } else {
        showDialog("ëŒ€ì¥ì¥ì´", "ê³¨ë“œê°€ ë¶€ì¡±í•˜êµ°...");
    }
}

function showDialog(name, text, buttons = [{t: "ë‹«ê¸°", f: closeDialog}]) {
    document.getElementById('speaker-name').innerText = name;
    document.getElementById('dialog-text').innerText = text;
    const btnContainer = document.getElementById('dialog-buttons');
    btnContainer.innerHTML = '';
    buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.className = "bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-sm font-bold transition";
        btn.innerText = b.t;
        btn.onclick = b.f;
        btnContainer.appendChild(btn);
    });
    document.getElementById('dialog').style.display = 'block';
}

function checkQuest() {
    const q = document.getElementById('quest-desc');
    if (state.questStep === 0) q.innerText = "ëŒ€ì¥ì¥ì´ì™€ ëŒ€í™”";
    else if (state.questStep === 1) {
        q.innerText = `ëª¬ìŠ¤í„° ì‚¬ëƒ¥ (${state.kills}/5)`;
        if (state.kills >= 5) { state.questStep = 2; checkQuest(); }
    } else if (state.questStep === 2) q.innerText = "ëŒ€ì¥ì¥ì´ì—ê²Œ ë³´ê³ ";
    else if (state.questStep === 3) q.innerText = "ë§ˆì™•ì˜ ì„± í† ë²Œ";
}

function drawBackground() {
    const loc = locations[state.location];
    
    // Sky
    ctx.fillStyle = loc.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Weather Effects
    state.time++;
    if (loc.weather === 'rain') {
        if (Math.random() < 0.3) spawnParticle(Math.random()*canvas.width, -10, '#a0aec0', 1);
        ctx.fillStyle = 'rgba(0,0,100,0.1)';
        ctx.fillRect(0,0,canvas.width, canvas.height);
    } else if (loc.weather === 'dark') {
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(0,0,canvas.width, canvas.height);
    }

    // Ground
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.fillRect(0, canvas.height * GROUND_Y, canvas.width, canvas.height * (1-GROUND_Y));
    ctx.restore();
    
    // Background Objects
    ctx.save();
    ctx.font = '80px serif';
    ctx.textAlign = 'center';
    if (loc.type === 'town') {
        ctx.fillText('ğŸ ', 150, canvas.height * GROUND_Y);
        ctx.fillText('ğŸ¯', canvas.width - 200, canvas.height * GROUND_Y);
        ctx.fillText('ğŸ‘¨â€ğŸŒ¾', canvas.width/2, canvas.height * GROUND_Y - 10);
    } else if (loc.type === 'field') {
        // Simple parallax-like static decor
        ctx.font = '40px serif';
        ctx.globalAlpha = 0.5;
        if (state.location.includes('forest')) ctx.fillText('ğŸŒ²', 100, canvas.height * GROUND_Y - 20);
        if (state.location.includes('desert')) ctx.fillText('ğŸŒµ', 200, canvas.height * GROUND_Y - 10);
        ctx.globalAlpha = 1;
    }
    ctx.restore();
}

function updateUI() {
    document.getElementById('gold').innerText = state.gold;
    document.getElementById('power').innerText = state.attackPower;
    document.getElementById('loot').innerText = state.loot;
    document.getElementById('location-name').innerText = locations[state.location].name;
    document.getElementById('level').innerText = state.level;
    document.getElementById('hp').innerText = Math.floor(state.hp);
    document.getElementById('max-hp').innerText = state.maxHp;
    document.getElementById('shop-gold').innerText = state.gold;
    
    // XP Bar
    const xpPercent = (state.xp / state.maxXp) * 100;
    document.getElementById('xp-bar').style.width = `${xpPercent}%`;
}

function sellLoot() {
    if (state.loot > 0) {
        const gain = state.loot * 30;
        state.gold += gain; state.loot = 0; updateUI();
        showDialog("ëŒ€ì¥ì¥ì´", `${gain}Gì— ëª¨ë‘ ë§¤ì…í–ˆë„¤. ë˜ ê°€ì ¸ì˜¤ê²Œë‚˜!`);
    } else showDialog("ëŒ€ì¥ì¥ì´", "íŒë§¤í•  ì „ë¦¬í’ˆì´ ì—†êµ°. ì‚¬ëƒ¥ì„ ì¢€ ë” í•˜ê³  ì˜¤ê²Œ.");
}

function closeDialog() { 
    document.getElementById('dialog').style.display = 'none'; 
    document.getElementById('shop').style.display = 'none'; 
}

// EXPANDED SHOP
const shopItems = [
    { name: "ìˆ˜ìŠµ ê¸°ì‚¬ì˜ ê²€", power: 25, price: 200, level: 2 },
    { name: "ì •ì˜ˆë³‘ì˜ ê°•ì² ê²€", power: 50, price: 600, level: 3 },
    { name: "í™”ì—¼ì˜ ë£¬ê²€", power: 120, price: 1500, level: 4 },
    { name: "ìš©ì‚¬ëƒ¥ê¾¼ì˜ ëŒ€ê²€", power: 300, price: 4000, level: 5 },
    { name: "ì „ì„¤ì˜ ì—‘ìŠ¤ì¹¼ë¦¬ë²„", power: 800, price: 10000, level: 6 },
    { name: "ì‹ ì‚´ìì˜ ë§ˆê²€", power: 2000, price: 30000, level: 7 },
    { name: "ìµœìƒê¸‰ ì²´ë ¥ ë¬¼ì•½", power: 0, price: 500, level: 99, type: 'potion' } // Consumable
];

function toggleShop() {
    state.shopVisible = !state.shopVisible;
    document.getElementById('shop').style.display = state.shopVisible ? 'block' : 'none';
    if (state.shopVisible) {
        const container = document.getElementById('shop-items');
        container.innerHTML = '';
        shopItems.forEach(item => {
            const isPotion = item.type === 'potion';
            const owned = !isPotion && state.weaponLevel >= item.level;
            const btn = document.createElement('div');
            btn.className = "flex justify-between items-center bg-gray-700 p-3 rounded-xl border border-gray-600";
            btn.innerHTML = `
                <div>
                    <div class="font-bold text-yellow-400">${item.name}</div>
                    <div class="text-xs text-gray-300">${isPotion ? 'ì²´ë ¥ ì™„ì „ íšŒë³µ' : 'ê³µê²©ë ¥: ' + item.power}</div>
                </div>
                <button onclick="buyItem(${item.level}, ${item.price}, ${item.power}, '${item.type}')" 
                    class="px-4 py-2 rounded-lg text-sm font-bold ${owned ? 'bg-gray-500' : 'bg-orange-500 hover:bg-orange-400'}" 
                    ${owned ? 'disabled' : ''}>
                    ${owned ? 'ë³´ìœ ì¤‘' : item.price + 'G'}
                </button>`;
            container.appendChild(btn);
        });
        updateUI();
    }
}

window.buyItem = function(lvl, price, pwr, type) {
    if (state.gold >= price) {
        if (type === 'potion') {
            state.gold -= price;
            state.hp = state.maxHp;
            showDialog("ìƒì ", "ì²´ë ¥ì´ ëª¨ë‘ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!");
        } else {
            state.gold -= price; state.weaponLevel = lvl; state.attackPower = pwr + (state.level * 2); // Weapon + Level scaling
        }
        updateUI(); toggleShop(); toggleShop(); // Refresh UI
        spawnParticle(player.x, player.y, '#00ff00', 20);
    } else {
        alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
    }
};

function setupControls() {
    const bind = (id, key) => {
        const el = document.getElementById(id);
        el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); initAudio(); keys[key] = true; };
        el.onmouseup = el.ontouchend = (e) => { e.preventDefault(); keys[key] = false; };
    };
    bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-jump', 'jump');
    document.getElementById('btn-attack').onclick = () => { initAudio(); player.attack(); };
    document.getElementById('btn-action').onclick = () => { initAudio(); player.interact(); };
}

// MAIN LOOP
player.interact = interactLogic; // Link interact function

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Screen Shake Effect
    if (state.screenShake > 0) {
        const dx = (Math.random() - 0.5) * state.screenShake;
        const dy = (Math.random() - 0.5) * state.screenShake;
        ctx.translate(dx, dy);
        state.screenShake *= 0.9;
        if (state.screenShake < 0.5) state.screenShake = 0;
    }

    drawBackground();
    
    // Particles (Weather & Effects)
    ctx.save();
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.update();
        if (p.life <= 0) particles.splice(i, 1);
        else p.draw();
    }
    ctx.restore();

    chests.forEach(c => c.draw());
    droppedItems.forEach(i => { i.update(); i.draw(); });

    player.update(); player.draw();

    if (locations[state.location].type === 'town') {
        villagers.forEach(v => { v.update(); v.draw(); });
    } else {
        monsters.forEach(m => { m.update(); m.draw(); });
    }

    // Damage Texts (Overlay)
    damageTexts.forEach((d, i) => {
        d.update();
        d.draw();
        if(d.life <= 0) damageTexts.splice(i,1);
    });
    
    // Reset transform from shake
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    
    requestAnimationFrame(loop);
}

setupControls();
changeLocation();
checkQuest();
requestAnimationFrame(loop);
</script>
</body>
</html>
